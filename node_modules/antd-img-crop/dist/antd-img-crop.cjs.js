'use strict';



function ___$insertStyle(css) {
  if (!css) {
    return;
  }
  if (typeof window === 'undefined') {
    return;
  }

  var style = document.createElement('style');

  style.setAttribute('type', 'text/css');
  style.innerHTML = css;
  document.head.appendChild(style);
  return css;
}

function _interopDefault (ex) { return (ex && (typeof ex === 'object') && 'default' in ex) ? ex['default'] : ex; }

function _interopNamespace(e) {
  if (e && e.__esModule) { return e; } else {
    var n = {};
    if (e) {
      Object.keys(e).forEach(function (k) {
        var d = Object.getOwnPropertyDescriptor(e, k);
        Object.defineProperty(n, k, d.get ? d : {
          enumerable: true,
          get: function () {
            return e[k];
          }
        });
      });
    }
    n['default'] = e;
    return n;
  }
}

require('antd/lib/modal/style/css');
var _Modal = _interopDefault(require('antd/lib/modal'));
var _regeneratorRuntime = _interopDefault(require('@babel/runtime/regenerator'));
var _asyncToGenerator = _interopDefault(require('@babel/runtime/helpers/asyncToGenerator'));
var _extends = _interopDefault(require('@babel/runtime/helpers/extends'));
var _assertThisInitialized = _interopDefault(require('@babel/runtime/helpers/assertThisInitialized'));
var _defineProperty = _interopDefault(require('@babel/runtime/helpers/defineProperty'));
var _inheritsLoose = _interopDefault(require('@babel/runtime/helpers/inheritsLoose'));
var _wrapNativeSuper = _interopDefault(require('@babel/runtime/helpers/wrapNativeSuper'));
var React = require('react');
var React__default = _interopDefault(React);
var PropTypes = _interopDefault(require('prop-types'));
var ReactCrop = _interopDefault(require('react-image-crop'));
var LocaleReceiver = _interopDefault(require('antd/lib/locale-provider/LocaleReceiver'));

___$insertStyle(".ReactCrop {\n  position: relative;\n  display: inline-block;\n  cursor: crosshair;\n  overflow: hidden;\n  max-width: 100%;\n  background-color: #000;\n}\n.ReactCrop:focus {\n  outline: none;\n}\n.ReactCrop--disabled, .ReactCrop--locked {\n  cursor: inherit;\n}\n.ReactCrop__image {\n  /* autoprefixer: off */\n  display: block;\n  max-width: 100%;\n  max-height: -webkit-fill-available;\n  max-height: -moz-available;\n  max-height: fill-available;\n  touch-action: manipulation;\n}\n.ReactCrop--crop-invisible .ReactCrop__image {\n  opacity: 0.5;\n}\n.ReactCrop__crop-selection {\n  position: absolute;\n  top: 0;\n  left: 0;\n  transform: translate3d(0, 0, 0);\n  box-sizing: border-box;\n  cursor: move;\n  box-shadow: 0 0 0 9999em rgba(0, 0, 0, 0.5);\n  touch-action: manipulation;\n  border: 1px solid;\n  border-image-source: url(\"data:image/gif;base64,R0lGODlhCgAKAJECAAAAAP///////wAAACH/C05FVFNDQVBFMi4wAwEAAAAh/wtYTVAgRGF0YVhNUDw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OEI5RDc5MTFDNkE2MTFFM0JCMDZEODI2QTI4MzJBOTIiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OEI5RDc5MTBDNkE2MTFFM0JCMDZEODI2QTI4MzJBOTIiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuZGlkOjAyODAxMTc0MDcyMDY4MTE4MDgzQzNDMjA5MzREQ0ZDIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjAyODAxMTc0MDcyMDY4MTE4MDgzQzNDMjA5MzREQ0ZDIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+Af/+/fz7+vn49/b19PPy8fDv7u3s6+rp6Ofm5eTj4uHg397d3Nva2djX1tXU09LR0M/OzczLysnIx8bFxMPCwcC/vr28u7q5uLe2tbSzsrGwr66trKuqqainpqWko6KhoJ+enZybmpmYl5aVlJOSkZCPjo2Mi4qJiIeGhYSDgoGAf359fHt6eXh3dnV0c3JxcG9ubWxramloZ2ZlZGNiYWBfXl1cW1pZWFdWVVRTUlFQT05NTEtKSUhHRkVEQ0JBQD8+PTw7Ojk4NzY1NDMyMTAvLi0sKyopKCcmJSQjIiEgHx4dHBsaGRgXFhUUExIREA8ODQwLCgkIBwYFBAMCAQAAIfkEBQoAAgAsAAAAAAoACgAAAhWEERkn7W3ei7KlagMWF/dKgYeyGAUAIfkEBQoAAgAsAAAAAAoACgAAAg+UYwLJ7RnQm7QmsCyVKhUAIfkEBQoAAgAsAAAAAAoACgAAAhCUYgLJHdiinNSAVfOEKoUCACH5BAUKAAIALAAAAAAKAAoAAAIRVISAdusPo3RAzYtjaMIaUQAAIfkEBQoAAgAsAAAAAAoACgAAAg+MDiem7Q8bSLFaG5il6xQAIfkEBQoAAgAsAAAAAAoACgAAAg+UYRLJ7QnQm7SmsCyVKhUAIfkEBQoAAgAsAAAAAAoACgAAAhCUYBLJDdiinNSEVfOEKoECACH5BAUKAAIALAAAAAAKAAoAAAIRFISBdusPo3RBzYsjaMIaUQAAOw==\");\n  border-image-slice: 1;\n  border-image-repeat: repeat;\n}\n.ReactCrop--disabled .ReactCrop__crop-selection {\n  cursor: inherit;\n}\n.ReactCrop--circular-crop .ReactCrop__crop-selection {\n  border-radius: 50%;\n}\n.ReactCrop__rule-of-thirds-vt::before, .ReactCrop__rule-of-thirds-vt::after, .ReactCrop__rule-of-thirds-hz::before, .ReactCrop__rule-of-thirds-hz::after {\n  content: \"\";\n  display: block;\n  position: absolute;\n  background-color: rgba(255, 255, 255, 0.9);\n}\n.ReactCrop__rule-of-thirds-vt::before, .ReactCrop__rule-of-thirds-vt::after {\n  width: 1px;\n  height: 100%;\n}\n.ReactCrop__rule-of-thirds-vt::before {\n  left: 33.3333%;\n  left: calc(100% / 3);\n}\n.ReactCrop__rule-of-thirds-vt::after {\n  left: 66.6666%;\n  left: calc(100% / 3 * 2);\n}\n.ReactCrop__rule-of-thirds-hz::before, .ReactCrop__rule-of-thirds-hz::after {\n  width: 100%;\n  height: 1px;\n}\n.ReactCrop__rule-of-thirds-hz::before {\n  top: 33.3333%;\n  top: calc(100% / 3);\n}\n.ReactCrop__rule-of-thirds-hz::after {\n  top: 66.6666%;\n  top: calc(100% / 3 * 2);\n}\n.ReactCrop__drag-handle {\n  position: absolute;\n  width: 10px;\n  height: 10px;\n  background-color: rgba(0, 0, 0, 0.2);\n  border: 1px solid rgba(255, 255, 255, 0.7);\n  box-sizing: border-box;\n  outline: 1px solid transparent;\n}\n.ReactCrop .ord-nw {\n  top: 0;\n  left: 0;\n  margin-top: -5px;\n  margin-left: -5px;\n  cursor: nw-resize;\n}\n.ReactCrop .ord-n {\n  top: 0;\n  left: 50%;\n  margin-top: -5px;\n  margin-left: -5px;\n  cursor: n-resize;\n}\n.ReactCrop .ord-ne {\n  top: 0;\n  right: 0;\n  margin-top: -5px;\n  margin-right: -5px;\n  cursor: ne-resize;\n}\n.ReactCrop .ord-e {\n  top: 50%;\n  right: 0;\n  margin-top: -5px;\n  margin-right: -5px;\n  cursor: e-resize;\n}\n.ReactCrop .ord-se {\n  bottom: 0;\n  right: 0;\n  margin-bottom: -5px;\n  margin-right: -5px;\n  cursor: se-resize;\n}\n.ReactCrop .ord-s {\n  bottom: 0;\n  left: 50%;\n  margin-bottom: -5px;\n  margin-left: -5px;\n  cursor: s-resize;\n}\n.ReactCrop .ord-sw {\n  bottom: 0;\n  left: 0;\n  margin-bottom: -5px;\n  margin-left: -5px;\n  cursor: sw-resize;\n}\n.ReactCrop .ord-w {\n  top: 50%;\n  left: 0;\n  margin-top: -5px;\n  margin-left: -5px;\n  cursor: w-resize;\n}\n.ReactCrop__disabled .ReactCrop__drag-handle {\n  cursor: inherit;\n}\n.ReactCrop__drag-bar {\n  position: absolute;\n}\n.ReactCrop__drag-bar.ord-n {\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 6px;\n  margin-top: -3px;\n}\n.ReactCrop__drag-bar.ord-e {\n  right: 0;\n  top: 0;\n  width: 6px;\n  height: 100%;\n  margin-right: -3px;\n}\n.ReactCrop__drag-bar.ord-s {\n  bottom: 0;\n  left: 0;\n  width: 100%;\n  height: 6px;\n  margin-bottom: -3px;\n}\n.ReactCrop__drag-bar.ord-w {\n  top: 0;\n  left: 0;\n  width: 6px;\n  height: 100%;\n  margin-left: -3px;\n}\n.ReactCrop--new-crop .ReactCrop__drag-bar, .ReactCrop--new-crop .ReactCrop__drag-handle, .ReactCrop--fixed-aspect .ReactCrop__drag-bar {\n  display: none;\n}\n.ReactCrop--fixed-aspect .ReactCrop__drag-handle.ord-n, .ReactCrop--fixed-aspect .ReactCrop__drag-handle.ord-e, .ReactCrop--fixed-aspect .ReactCrop__drag-handle.ord-s, .ReactCrop--fixed-aspect .ReactCrop__drag-handle.ord-w {\n  display: none;\n}\n@media (pointer: coarse) {\n  .ReactCrop__drag-handle {\n    width: 20px;\n    height: 20px;\n  }\n  .ReactCrop .ord-nw {\n    margin-top: -10px;\n    margin-left: -10px;\n  }\n  .ReactCrop .ord-n {\n    margin-top: -10px;\n    margin-left: -10px;\n  }\n  .ReactCrop .ord-ne {\n    margin-top: -10px;\n    margin-right: -10px;\n  }\n  .ReactCrop .ord-e {\n    margin-top: -10px;\n    margin-right: -10px;\n  }\n  .ReactCrop .ord-se {\n    margin-bottom: -10px;\n    margin-right: -10px;\n  }\n  .ReactCrop .ord-s {\n    margin-bottom: -10px;\n    margin-left: -10px;\n  }\n  .ReactCrop .ord-sw {\n    margin-bottom: -10px;\n    margin-left: -10px;\n  }\n  .ReactCrop .ord-w {\n    margin-top: -10px;\n    margin-left: -10px;\n  }\n  .ReactCrop__drag-bar.ord-n {\n    height: 16px;\n    margin-top: -8px;\n  }\n  .ReactCrop__drag-bar.ord-e {\n    width: 16px;\n    margin-right: -8px;\n  }\n  .ReactCrop__drag-bar.ord-s {\n    height: 16px;\n    margin-bottom: -8px;\n  }\n  .ReactCrop__drag-bar.ord-w {\n    width: 16px;\n    margin-left: -8px;\n  }\n}\n\n.antd-img-crop-modal .ant-modal .ant-modal-body {\n  display: flex;\n  justify-content: center;\n}\n.antd-img-crop-modal .ant-modal .ant-modal-body .ReactCrop__image {\n  max-height: none;\n}");

try {
  new File([], '');
} catch (e) {
  // 兼容 IE new File()
  new Promise(function (resolve) { resolve(_interopNamespace(require('canvas-toBlob'))); }).then(function () {
    /* eslint-disable-next-line */
    File =
    /*#__PURE__*/
    function (_Blob) {
      _inheritsLoose(File, _Blob);

      function File(chunks, filename, opts) {
        var _this;

        if (opts === void 0) {
          opts = {};
        }

        _this = _Blob.call(this, chunks, opts) || this;
        _this.lastModifiedDate = new Date();
        _this.lastModified = +_this.lastModifiedDate;
        _this.name = filename;
        return _this;
      }

      return File;
    }(_wrapNativeSuper(Blob));
  });
}

var MODAL_TITLE = 'Edit image';
var NOT_ONLY_ERR = '`children` to `<ImgCrop />` must be only `<Upload />`';

var ImgCrop =
/*#__PURE__*/
function (_Component) {
  _inheritsLoose(ImgCrop, _Component);

  function ImgCrop(props) {
    var _this2;

    _this2 = _Component.call(this, props) || this;

    _defineProperty(_assertThisInitialized(_this2), "renderUpload", function () {
      var children = _this2.props.children;
      var Upload;

      if (_this2.newUploadProps === undefined) {
        if (Array.isArray(children)) {
          if (children.length > 1) throw new Error(NOT_ONLY_ERR);
          Upload = children[0];
        } else {
          Upload = children;
        }

        if (!Upload.type.defaultProps.beforeUpload) throw new Error(NOT_ONLY_ERR);
        var _Upload$props = Upload.props,
            accept = _Upload$props.accept,
            beforeUpload = _Upload$props.beforeUpload;
        _this2.realBeforeUpload = beforeUpload;
        _this2.newUploadProps = {
          accept: !accept ? 'image/*' : accept,
          beforeUpload: _this2.beforeUpload
        };
      } else {
        Upload = Array.isArray(children) ? children[0] : children;
      }

      return _extends({}, Upload, {
        props: _extends({}, Upload.props, {}, _this2.newUploadProps)
      });
    });

    _defineProperty(_assertThisInitialized(_this2), "beforeUpload", function (file, fileList) {
      return new Promise(function (resolve, reject) {
        _this2.resolve = resolve;
        _this2.reject = reject; // 裁剪前校验图片

        var beforeCrop = _this2.props.beforeCrop;

        if (beforeCrop && !beforeCrop(file, fileList)) {
          _this2.reject();

          return;
        }

        _this2.originalFIle = file; // 读取添加的图片

        var reader = new FileReader();
        reader.addEventListener('load', function () {
          _this2.setState({
            modalVisible: true,
            src: reader.result
          });
        });
        reader.readAsDataURL(_this2.originalFIle); // then -> `onImageLoaded`
      });
    });

    _defineProperty(_assertThisInitialized(_this2), "onImageLoaded", function (image) {
      if (_this2.imageRef !== undefined) return;
      _this2.imageRef = image;
      var _this2$imageRef = _this2.imageRef,
          naturalWidth = _this2$imageRef.naturalWidth,
          naturalHeight = _this2$imageRef.naturalHeight;
      var imgWidth = naturalWidth;
      var imgHeight = naturalHeight;
      var _this2$props = _this2.props,
          modalWidth = _this2$props.modalWidth,
          cropWidth = _this2$props.width,
          cropHeight = _this2$props.height,
          useRatio = _this2$props.useRatio;
      var modalBodyWidth = modalWidth - 24 * 2;

      if (naturalWidth > modalBodyWidth) {
        imgWidth = modalBodyWidth;
        _this2.scale = naturalWidth / imgWidth;
        imgHeight = naturalHeight / _this2.scale;
      }

      var aspect = cropWidth / cropHeight;
      var x;
      var y;
      var width;
      var height;

      if (useRatio === true) {
        var naturalAspect = naturalWidth / naturalHeight;

        if (naturalAspect > aspect) {
          y = 0;
          height = imgHeight;
          width = height * aspect;
          x = (imgWidth - width) / 2;
        } else {
          x = 0;
          width = imgWidth;
          height = width / aspect;
          y = (imgHeight - height) / 2;
        }
      } else {
        x = (imgWidth - cropWidth) / 2;
        y = (imgHeight - cropHeight) / 2;
        width = cropWidth;
        height = cropHeight;
      }

      _this2.setState({
        crop: {
          unit: 'px',
          aspect: aspect,
          x: x,
          y: y,
          width: width,
          height: height
        }
      });

      return false;
    });

    _defineProperty(_assertThisInitialized(_this2), "onCropChange", function (crop) {
      _this2.setState({
        crop: crop
      });
    });

    _defineProperty(_assertThisInitialized(_this2), "onOk",
    /*#__PURE__*/
    _asyncToGenerator(
    /*#__PURE__*/
    _regeneratorRuntime.mark(function _callee2() {
      var crop, x, y, width, height, canvas, ctx, _this2$originalFIle, name, type, uid;

      return _regeneratorRuntime.wrap(function _callee2$(_context2) {
        while (1) {
          switch (_context2.prev = _context2.next) {
            case 0:
              crop = _this2.state.crop;
              x = crop.x, y = crop.y, width = crop.width, height = crop.height;

              if (!(!width || !height)) {
                _context2.next = 5;
                break;
              }

              _this2.onClose();

              return _context2.abrupt("return");

            case 5:
              if (_this2.scale !== undefined) {
                x = x * _this2.scale;
                y = y * _this2.scale;
                width = width * _this2.scale;
                height = height * _this2.scale;
              } // 获取裁切后的图片


              canvas = document.createElement('canvas');
              canvas.width = width;
              canvas.height = height;
              ctx = canvas.getContext('2d');
              ctx.drawImage(_this2.imageRef, x, y, width, height, 0, 0, width, height);
              _this2$originalFIle = _this2.originalFIle, name = _this2$originalFIle.name, type = _this2$originalFIle.type, uid = _this2$originalFIle.uid;
              canvas.toBlob(
              /*#__PURE__*/
              function () {
                var _ref2 = _asyncToGenerator(
                /*#__PURE__*/
                _regeneratorRuntime.mark(function _callee(blob) {
                  var croppedFile, response, croppedProcessedFile, fileType, useProcessedFile;
                  return _regeneratorRuntime.wrap(function _callee$(_context) {
                    while (1) {
                      switch (_context.prev = _context.next) {
                        case 0:
                          // 生成新图片
                          croppedFile = new File([blob], name, {
                            type: type,
                            lastModified: Date.now()
                          });
                          croppedFile.uid = uid; // 关闭弹窗

                          _this2.onClose(); // 调用 beforeUpload


                          response = _this2.realBeforeUpload(croppedFile, [croppedFile]);

                          if (!(response === false)) {
                            _context.next = 7;
                            break;
                          }

                          _this2.reject();

                          return _context.abrupt("return");

                        case 7:
                          if (!(typeof response.then !== 'function')) {
                            _context.next = 10;
                            break;
                          }

                          _this2.resolve(croppedFile);

                          return _context.abrupt("return");

                        case 10:
                          _context.prev = 10;
                          _context.next = 13;
                          return response;

                        case 13:
                          croppedProcessedFile = _context.sent;
                          fileType = Object.prototype.toString.call(croppedProcessedFile);
                          useProcessedFile = fileType === '[object File]' || fileType === '[object Blob]';

                          _this2.resolve(useProcessedFile ? croppedProcessedFile : croppedFile);

                          _context.next = 22;
                          break;

                        case 19:
                          _context.prev = 19;
                          _context.t0 = _context["catch"](10);

                          _this2.reject(_context.t0);

                        case 22:
                        case "end":
                          return _context.stop();
                      }
                    }
                  }, _callee, null, [[10, 19]]);
                }));

                return function (_x) {
                  return _ref2.apply(this, arguments);
                };
              }(), type);

            case 13:
            case "end":
              return _context2.stop();
          }
        }
      }, _callee2);
    })));

    _defineProperty(_assertThisInitialized(_this2), "onClose", function () {
      _this2.imageRef = undefined;
      _this2.scale = undefined;

      _this2.setState({
        modalVisible: false,
        crop: {}
      });
    });

    _this2.state = {
      modalVisible: false,
      src: null,
      crop: {}
    };
    return _this2;
  }
  /**
   * Upload 组件
   */
  // 渲染 Upload 组件


  var _proto = ImgCrop.prototype;

  _proto.render = function render() {
    var _this3 = this;

    var _this$props = this.props,
        modalTitle = _this$props.modalTitle,
        modalWidth = _this$props.modalWidth,
        resize = _this$props.resize,
        resizeAndDrag = _this$props.resizeAndDrag;
    var _this$state = this.state,
        modalVisible = _this$state.modalVisible,
        src = _this$state.src,
        crop = _this$state.crop;
    return React__default.createElement(LocaleReceiver, null, function (locale, localeCode) {
      return React__default.createElement(React__default.Fragment, null, _this3.renderUpload(), React__default.createElement(_Modal, {
        visible: modalVisible,
        width: modalWidth,
        onOk: _this3.onOk,
        onCancel: _this3.onClose,
        wrapClassName: "antd-img-crop-modal",
        title: localeCode === 'zh-cn' && modalTitle === MODAL_TITLE ? '编辑图片' : modalTitle,
        maskClosable: false,
        destroyOnClose: true
      }, src && React__default.createElement(ReactCrop, {
        src: src,
        crop: crop,
        locked: resize === false,
        disabled: resizeAndDrag === false,
        onImageLoaded: _this3.onImageLoaded,
        onChange: _this3.onCropChange,
        keepSelection: true
      })));
    });
  };

  return ImgCrop;
}(React.Component);

ImgCrop.propTypes = {
  width: PropTypes.number,
  height: PropTypes.number,
  useRatio: PropTypes.bool,
  resize: PropTypes.bool,
  resizeAndDrag: PropTypes.bool,
  modalTitle: PropTypes.string,
  modalWidth: PropTypes.number,
  beforeCrop: PropTypes.func,
  children: PropTypes.node
};
ImgCrop.defaultProps = {
  width: 100,
  height: 100,
  useRatio: false,
  resize: true,
  resizeAndDrag: true,
  modalTitle: MODAL_TITLE,
  modalWidth: 520
};

module.exports = ImgCrop;
